name: TruffleHog Maximum-Coverage Scan

on:
  workflow_dispatch:       # manual trigger from the Actions tab only

permissions:
  contents: read           # read code
  security-events: write   # upload SARIF if you later enable it
  actions: read

jobs:
  trufflehog-max:
    name: Full-History Secret Scan (MAX)
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout full history (all branches + tags)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0         # full history
        fetch-tags: true
        ref: ${{ github.sha }} # assure current revision

    # 2. Run TruffleHog with every detector, no filtering
    - name: TruffleHog MAX scan
      id: trufflehog
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true          # **never fails the job**
      with:
        # Empty base/head = scan the entire repo history
        base: ""                       # full scan
        head: ""                       # full scan
        # Extra CLI flags for _absolute_ coverage
        extra_args: >-
          --json
          --include-detectors=all
          --no-verification
          --results=verified,unknown,unverified,filtered_unverified
          --archive-max-size=500MB
          --archive-max-depth=20
          --archive-timeout=10m
          --concurrency=8
          --debug

    # 3. Upload raw JSON results for later analysis
    - name: Upload TruffleHog JSON report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trufflehog-max-results
        path: trufflehog_results.json      # auto-generated file

    # 4. Summarise findings in the workflow run
    - name: Summarise results
      if: always()
      run: |
        echo "## TruffleHog Maximum-Coverage Scan :mag_right:" >> $GITHUB_STEP_SUMMARY
        if [[ -f trufflehog_results.json ]]; then
          count=$(jq 'length' trufflehog_results.json)
        else
          count=0
        fi
        echo "- **Total findings**: $count" >> $GITHUB_STEP_SUMMARY
        echo "- **Verification**: disabled (all potential secrets shown)" >> $GITHUB_STEP_SUMMARY
        echo "- **Detectors enabled**: all" >> $GITHUB_STEP_SUMMARY
        echo "- **Scan scope**: full repo history (all branches & tags)" >> $GITHUB_STEP_SUMMARY
        if [[ $count -gt 0 ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Review the artifact **trufflehog-max-results** for full detail." >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ No credentials detected." >> $GITHUB_STEP_SUMMARY
        fi
